<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="mikoto_speech.css" >
    <title>Save The Oracle Solver (Klotski Solver)</title>
    <style>
      @font-face {
	  font-family: 'MeiryoB';
	  src: url('../fonts/MeiryoUI-Bold.woff2') format('woff2'),
	       url('../fonts/MeiryoUI-Bold.woff') format('woff');
	  font-weight: bold;
	  font-style: normal;
      font-display: swap;
      }

      :root {
          --bg-color: #1a1a1a;
          --surface-color: #2c2c2c;
          --button-color: #3c3c3c;
          --button-accent-color: #8e8c8e;
          --primary-text-color: #e0e0e0;
          --secondary-text-color: #a0a0a0;
          --primary-accent-color: #8c9eff;
          --secondary-accent-color: #5c6bc0;
          --success-color: #66bb6a;
          --error-color: #ef5350;
          --border-color: #424242;
      }
      html {
          height: 100%;
      }
      body {
          font-family: 'MeryoB', sans-serif;
          padding: 10px;
          margin: 10px;
          display: flex;
          height: 100vh;
          min-width: 700px;
          min-height: 100vh;
          flex-direction: column;
          background-color: var(--bg-color);
          color: var(--primary-text-color);
          overflow: hidden;
      }
      .main-container {
	  width:800px;
          max-width: 800px;
	  box-sizing: border-box;	  
      }
      .top-panel {
          padding-top: 10px;
          overflow-y: auto;
          flex-shrink: 0;
          font-size: 14px;
	  width:800px;
          max-width: 800px;
	  box-sizing: border-box;	  
      }
      .container {
            background-size: cover;
            background-repeat: no-repeat;
            background-position: left;
            justify-content: left;
            max-width: 800px;
            width:800px;
            margin: 0 20px 0;
            padding: 14px 25px 0; /* 上、左右、下 */
            background-color: var(--surface-color);
            border-radius: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            text-align: left;
	    box-sizing: border-box;
      }
      .bottom-panel {
          flex-grow: 1;
          overflow-y: auto;
          padding-bottom: 20px;
	  width:800px;
          max-width: 800px;
	  box-sizing: border-box;
	  z-index: -100;
      }
      
      .controls-container {
          position: relative;
	  width: 800px;
	  max-width: 800px;
	  width: 800px;	  
	  flex-shrink: 0;
	  justify-content: left;
	  background-color: rgba(44, 44, 44, 0.85); /* 背景画像が見えるように半透明のオーバーレイに変更 */
	  border-radius: 18px;
	  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
	  box-sizing: border-box;
	  text-align: left;
	  z-index: 1;
      }
      
      .top-panel .controls-container {
	  background-size: cover;
	  background-repeat: no-repeat;
	  background-position: left;
	  background-image:
	      linear-gradient(to right, rgba(0, 0, 0, 0.6), rgba(255, 255, 255, 0));
      }
      .bottom-panel .container {
	       /* background-image: none; */
	       background: transparent;
	       box-shadow: none;
	       /* justify-content: center; */ /* This has no effect on a block element */
	       margin-bottom: 25px;
      }
      .controls-container::before, .controls-container::after {
	  content: '';
	  position: absolute;
	  top: 0; left: 0; right: 0; bottom: 0;
	  background-size: cover;
	  background-repeat: no-repeat;
	  background-position: left;
	  border-radius: 18px;  /* Match containers border-radius */
	  z-index: -1;
      }

      .controls-container::before {
	  background-image: url(bg_solver.jpg);
      }
      .controls-container::after {
	  background-image: var(--after-bg-image, none);
	  opacity: 0;
	  transition: opacity 0.4s ease-in-out;
      }
      .controls-container.bg-active::after {
	  opacity: 1;
      }


      h1 {
	  color: var(--primary-text-color);
	  margin-bottom: 24px;
      }

      .info {
	  background-color: rgba(92, 107, 192, 0.15);
	  border-left: 5px solid var(--secondary-accent-color);
	  padding: 15px;
	  margin-bottom: 20px;
	  border-radius: 4px;
	  text-align: left;
      }

      .info p {
	  margin: 0;
	  line-height: 1.6;
      }

      .board {
	  white-space: pre;
	  font-family: monospace;
	  line-height: 1.1;
	  font-size: 1.5em;
	  margin-bottom: 20px;
	  text-align: left;
	  border: 2px solid var(--border-color);
	  display: inline-block;
	  padding: 4px;
	  border-radius: 4px;
	  background-color: var(--bg-color);
      }

      button {
	  background-color: var(--secondary-accent-color);
	  color: white;
	  padding: 12px 24px;
	  border: none;
	  border-radius: 5px;
	  font-size: 1em;
	  cursor: pointer;
	  transition: background-color 0.3s, transform 0.2s;
	  margin-bottom: 20px;
	  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }

      button:hover {
	  background-color: var(--primary-accent-color);
	  transform: translateY(-2px);
      }

      button:disabled {
	  background-color: #424242;
	  color: #757575;
	  cursor: not-allowed;
	  box-shadow: none;
	  transform: none;
      }
      .icon-btn img {
	  width: 64px;
	  height: 64px;
      }
      /* Icon-based UI styles */
      .action-buttons, .icon-group {
	  display: flex;
	  justify-content: flex-start;
	  gap: 0;
	  align-items: center;
      }
      .action-buttons {
	  margin-bottom: 10px; /* ボタン下のマージン */
      }

      .icon-btn {
	  /* Reset default button styles */
	  -webkit-appearance: none;
	  -moz-appearance: none;
	  appearance: none;
	  background: none;
	  padding: 0;
	  font-family: inherit;
	  color: inherit;

	  /* Icon styles */
	  width: 56px;
	  height: 56px;
	  background-color: #3a3a3a;
	  border: 2px solid #5a5a5a;
	  border-radius: 6px;
	  display: inline-flex; /* Use flex to center content */
	  align-items: center;
	  justify-content: center;

	  font-size: 2em;
	  cursor: pointer;
	  transition: all 0.2s ease;
	  user-select: none;
	  margin: 0;
      }

      #start-buttons-group {
	  display: flex;
	  align-items: center;
	  gap: 0;
      }

      .action-buttons.searching .icon-btn-label:not(.active-search) {
	  opacity: 0.4;
	  pointer-events: none;
      }

      .icon-btn:hover:not(:disabled) {
	  background-color: #4a4a4a;
	  border-color: var(--primary-accent-color);
	  transform: translateY(-2px);
	  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      }

      .icon-btn:disabled {
	  background-color: #2a2a2a;
	  border-color: #424242;
	  color: #666;
	  cursor: not-allowed;
	  transform: none;
	  box-shadow: none;
      }

      /* Hide the actual radio/checkbox input */
      .icon-group input {
	  position: absolute;
	  opacity: 0;
	  width: 0;
	  height: 0;
      }

      #status {
	  font-size: 1em;
	  font-weight: bold;
	  color: var(--primary-accent-color);
      }

      #search-summary {
	  background-color: rgba(44, 44, 44, 0.5); /* 半透明の背景 */
	  backdrop-filter: blur(4px); /* すりガラス効果 */
	  -webkit-backdrop-filter: blur(4px); /* Safari用 */
	  border-radius: 8px;
	  padding: 15px 25px;
	  margin-bottom: 20px;
	  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
	  border: 1px solid rgba(255, 255, 255, 0.1); /* 境界線を少し見せる */
      }

      #progress-details {
	  font-size: 0.7em;
	  color: var(--secondary-text-color);
	  margin-top: 0;
      }

      #save-status {
	  font-size: 0.9em;
	  color: var(--error-color);
	  margin-top: 10px;
	  min-height: 20px;
      }
      #save-status[style*="color: rgb(76, 175, 80)"] { /* For success message */
	  color: var(--success-color) !important;
      }

      #solution-path {
	  margin-top: 0;
	  text-align: left;
	  display: grid;
	  grid-template-columns: repeat(15, 1fr);
	  gap: 2px;
      }
      .step {
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  gap: 2px;
      }

      .step-number {
	  font-size: 0.78em;
	  font-weight: bold;
	  align-items: left;
	  color: var(--secondary-text-color);
      }
      .step-board {
	  font-family:MeiryoB;
	  border: 1px solid var(--border-color);
	  padding: 4px 8px;
	  border-radius: 4px;
	  background-color: var(--bg-color);
	  justify-content: left;
	  white-space: pre;
	  font-family: monospace;
	  line-height: 1.1;
	  font-size: 1.1em;
	  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Style for when the hidden input is disabled */
      .icon-group input:disabled + .icon-label {
	  background-color: #2a2a2a;
	  border-color: #424242;
	  color: #666;
	  cursor: not-allowed;
	  box-shadow: none;
      }

      .step-board.clickable-board {
	  cursor: pointer;
	  transition: border-color 0.2s ease;
      }
      .step-board.clickable-board:hover {
	  border-color: var(--primary-accent-color);
      }
      .moved-piece {
	  color: var(--success-color);
	  font-weight: bold;
      }
      .board-input-container {
	  display: flex;
	  align-items: center;
	  gap: 10px;

      }
      #initial-state-input {
	  /* flex-grow: 1; */
	  font-family: monospace;
	  width: 22ch; /* 20文字とパディング分を考慮 */
	  font-size: 1em;
	  padding: 7px;
	  border: 1px solid var(--border-color);
	  border-radius: 8px;
	  background-color: var(--bg-color);
	  color: var(--primary-text-color);
      }
      #set-state-btn {
	  padding: 4px 35px ;
	  margin: 0;
	  border: 1px solid var(--border-color);
	  flex-shrink: 0;
      }
      #set-state-status {
	  min-height: 1.2em;
	  font-size: 0.9em;
	  text-align: left;
	  margin-top: 5px;
      }
      #set-state-status[style*="color: rgb(76, 175, 80)"] { /* For success message */
	  color: var(--success-color) !important;
      }
      .pruning-selection {
	  margin-bottom: 20px;
	  /* text-align: center; */
      }
      .pruning-selection label {
	  margin: 0 10px;
	  font-size: 1em;
	  cursor: pointer;
      }
      #pruning-status {
	  color: var(--secondary-text-color);
	  margin-left: 10px;
	  font-size: 0.9em;
      }

      .separated-icon-label {
	  margin-left: 20px; /* IDA*を他のアイコンから離す */
      }

      .icon-btn-label {
	  position: relative;
	  display: inline-block;
      }


      /* --- Tooltip Styles --- */
      .tooltip-text {
	  visibility: hidden;
	  width: 280px; /* ツールチップの幅 */
	  background-color: rgba(44, 44, 44, 0.1); /* 半透明の背景 */
	  backdrop-filter: blur(4px); /* すりガラス効果 */
	  -webkit-backdrop-filter: blur(4px); /* Safari用 */
	  color: var(--primary-text-color);
	  text-align: left;
	  border-radius: 6px;
	  padding: 10px 15px;
	  position: fixed; /* JSでビューポート基準の位置を計算するため */
	  z-index: 1000;
	  opacity: 0;
	  transition: opacity 0.3s ease;
	  font-size: 0.9em;
	  line-height: 1.5;
	  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
	  pointer-events: none; /* ツールチップ自体がマウスイベントを妨げないようにする */
	  --arrow-left: 50%; /* JSから矢印の位置を動的に設定するためのCSS変数 */
      }
      /* ツールチップの矢印 */
      .tooltip-text::after {
	  content: "";
	  position: absolute;
	  left: var(--arrow-left);
	  transform: translateX(-50%);
	  border-width: 5px;
	  border-style: solid;
      }

      /* 上に表示する場合の矢印（下向き） */
      .tooltip-text.arrow-down::after {
	  top: 100%;
	  border-color:rgba(44, 44, 44, 0.85) transparent transparent transparent;
      }

      /* 下に表示する場合の矢印（上向き） */
      .tooltip-text.arrow-up::after {
	  bottom: 100%;
	  border-color: transparent transparent rgba(44, 44, 44, 0.85) transparent;
      }

      /* ホバー時にツールチップを表示 */
      .tooltip-text.visible {
	  visibility: visible;
	  opacity: 1;
      }
      .tooltip-text strong {
	  color: var(--primary-accent-color);
	  font-weight: bold;
      }

      /* --- Settings Panel Styles --- */
      .settings-container {
          margin-bottom: 20px;
      }
      .advanced-settings-panel {
          background-color: rgba(0,0,0,0.2);
          border: 1px solid var(--border-color);
          border-radius: 6px;
          padding: 15px;
          margin-top: 10px;
          flex-direction: column;
          gap: 10px;
      }
      .advanced-settings-panel:not([hidden]) {
          display: flex;
      }
      .checkbox-label {
          display: flex;
          align-items: center;
          gap: 8px;
      }
      /* --- Board Editor Styles --- */
      .board-editor-container {
          margin-top: 20px;
          padding-top: 20px;
          border-top: 1px solid var(--border-color);
      }
      .board-editor-container h2 {
          margin-top: 0;
          margin-bottom: 15px;
          font-size: 1.2em;
      }
      .grid-wrapper {
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      .editor-layout {
          display: flex;
          gap: 20px;
          margin-bottom: 15px;
      }
      .editor-grid {
          position: relative; /* For highlight overlay */
          display: grid;
          grid-template-columns: repeat(4, 36px);
          grid-template-rows: repeat(5, 36px);
          gap: 0;
          border-top: 1px solid var(--border-color);
          border-left: 1px solid var(--border-color);
          padding: 0;
      }
      .editor-grid-cell {
          width: 36px;
          height: 36px;
          background-color: var(--surface-color);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-family: monospace;
          font-size: 1.2em;
          font-weight: bold;
          user-select: none;
          box-sizing: border-box;
          border-right: 1px solid var(--border-color);
          border-bottom: 1px solid var(--border-color);
      }
      /* ターゲットの盤面を強調表示 */
      #target-grid {
          border-top-color: var(--secondary-accent-color);
          border-left-color: var(--secondary-accent-color);
      }
      #target-grid .editor-grid-cell {
          border-right-color: var(--secondary-accent-color);
          border-bottom-color: var(--secondary-accent-color);
      }
      .piece-inner-right { border-right-color: transparent; }
      .piece-inner-bottom { border-bottom-color: transparent; }
      /* ターゲット盤面でも内側の線を消すための、より詳細なセレクタ */
      #target-grid .editor-grid-cell.piece-inner-right { border-right-color: transparent; }
      #target-grid .editor-grid-cell.piece-inner-bottom { border-bottom-color: transparent; }

      .editor-grid-cell.preview-piece {
          background-color: rgba(255, 255, 255, 0.2);
      }

      .editor-grid-cell.hovered-piece { filter: brightness(1.25); }
      #selection-highlight {
          position: absolute;
          border: 2px solid var(--primary-accent-color);
          box-shadow: 0 0 10px var(--primary-accent-color);
          border-radius: 4px;
          pointer-events: none;
          box-sizing: border-box;
          transition: opacity 0.15s ease-in-out;
      }
      .editor-actions {
          margin-top: 15px;
      }
      .editor-actions button {
          padding: 6px 12px;
          font-size: 0.9em;
          margin: 0 10px 0 0;
      }
      /* Piece Colors */
      .piece-A { background-color: #c62828; color: white; } /* 2x2, Red */
      .piece-B { background-color: #2e7d32; color: white; } /* 2x1, Green */
      .piece-C { background-color: #0277bd; color: white; } /* 1x2, Blue */
      .piece-D { background-color: #6a1b9a; color: white; } /* 1x2, Purple */
      .piece-E { background-color: #00695c; color: white; } /* 1x2, Teal */
      .piece-F { background-color: #283593; color: white; } /* 1x2, Indigo */
      .piece-G { background-color: #f9a825; color: black; } /* 1x1, Yellow */
      .piece-H { background-color: #c2185b; color: white; } /* 1x1, Pink */
      .piece-I { background-color: #ef6c00; color: white; } /* 1x1, Orange */
      .piece-J { background-color: #5d4037; color: white; } /* 1x1, Brown */
      .piece-dot { background-color: var(--surface-color); }

    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="top-panel">
        <div class="controls-container">
        <h1>SAVE THE ORACLE SOLVER</h1>
        <div class="board-input-container">
          <strong>初期盤面:</strong>
          <input type="text" id="initial-state-input" maxlength="20" minlength="20"
		 title="20文字の盤面状態 (A-Z, .)">
          <button id="set-state-btn">OK </button> <div id="set-state-status"></div>
        </div>
        <div class="settings-container">
          <div id="advanced-settings-panel" class="advanced-settings-panel" hidden>
            <label class="checkbox-label">
              <input type="checkbox" id="pruning-enabled" disabled> 最短解データによる枝刈り
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="use-local-visited-enabled" disabled> 保存済み探索データの利用
            </label>
            <div class="board-editor-container">
              <h2>盤面エディタ</h2>
              <div class="editor-layout">
                <div class="grid-wrapper">
                  <h3>ソース</h3>
                  <div id="source-grid" class="editor-grid"></div>
                </div>
                <div class="grid-wrapper">
                  <h3>ターゲット</h3>
                  <div id="target-grid" class="editor-grid"></div>
                  <div class="editor-actions">
                    <button id="apply-editor-btn">この盤面を適用</button>
                    <button id="reset-editor-btn">リセット</button>
                  </div>
                </div>
              </div>
              <p style="font-size: 0.8em; color: var(--secondary-text-color); margin-top: 10px;">左の盤の駒をクリックで選択し、右の盤をクリックで配置します。<br>右の盤に配置した駒は右クリックで左の盤に戻せます。</p>
            </div>
          </div>
          <span id="pruning-status"></span>
        </div>
        <div class="action-buttons">
          <label class="icon-btn-label">
            <button class="icon-btn start-algorithm-btn" value="bfs">
              <img src="../img/icon/bfs.png" alt="BFS">
            </button>
            <span class="tooltip-text">
              <strong>Brave Forwards Search (BFS)</strong><br>
              アルフィノがシャーレアン魔法大学在学中に開発したとされる最も基本的な探索アルゴリズム。
	      スタートから近い順に全てのノードを網羅的に探索するため、必ず最短手数解を見つけます。
            </span>
          </label>
          <label class="icon-btn-label">
            <button class="icon-btn start-algorithm-btn" value="astar">
              <img src="../img/icon/astar.png" alt="A*">
            </button>
            <span class="tooltip-text">
              <strong>All-encompassed Super Tech Aragan Research (A*)</strong><br>
              ネロがアラグの超技術を利用して開発したらしい探索アルゴリズム。
	      ゴールまでの推定コストを利用して探索を効率化、BFSと同様に最短手数解を保証しつつ、
	      より高速に解を見つけることができます。
            </span>
          </label>
          <label class="icon-btn-label separated-icon-label">
            <button class="icon-btn start-algorithm-btn" value="idastar">
              <img src="../img/icon/idastar.png" alt="IDA*">
            </button>
            <span class="tooltip-text">
              <strong>Ironworks Designed Astar (IDA*)</strong><br>
              シドが開発したかもしれないA*探索の改良版。メモリ使用量を抑えられますが、
	      このパズルのように同じ状態に何度も到達する問題では探索効率が著しく低下する場合があります。(試験的実装)
            </span>
          </label>

          <span style="border-left: 2px solid var(--border-color); height: 40px; margin: 0 15px;"></span>

          <label class="icon-btn-label">
            <button id="save-btn" class="icon-btn" disabled>
              <img src="../img/icon/save.png" alt="Save">
            </button>
            <span class="tooltip-text">
              <strong>探索結果を保存</strong><br>
              今回の探索で訪れた盤面（探索済みノード）をブラウザに保存します。次回以降の探索で再利用できます。
            </span>
          </label>
          <label class="icon-btn-label">
            <button id="check-data-btn" class="icon-btn">
              <img src="../img/icon/check.png" alt="Check">
            </button>
            <span class="tooltip-text">
              <strong>データ整合性チェック</strong><br>
              ブラウザに保存された探索済みデータに重複がないかチェックし、必要であればクリーンアップします。
            </span>
          </label>
          <label class="icon-btn-label">
            <button id="advanced-settings-btn" class="icon-btn">
              <img src="../img/icon/config.png" alt="Settings">
            </button>
            <span class="tooltip-text">
              <strong>詳細設定</strong><br>
              枝刈りや保存済みデータの利用など、探索に関する高度な設定を行います。
            </span>
          </label>
        </div>
        <div id="save-status"></div>
      </div>
      </div>
    </div>
    <div class="bottom-panel">
        <div id="search-summary" hidden>
          <div id="status"></div>
          <div id="progress-details"></div>
        </div>
        <div id="solution-path"></div>
    </div>

    <!-- Mikoto's Speech Modal -->
    <div id="mikoto-modal">
      <div class="mikoto-modal-content" title="クリックして進む">
        <button id="mikoto-modal-close" aria-label="閉じる">&times;</button>
        <div class="mikoto-slide slide-0 is-active"></div>
        <div class="mikoto-slide slide-1"></div>
        <div class="mikoto-slide slide-2"></div>
        <div class="mikoto-slide slide-3"></div>
        <div class="mikoto-slide slide-4"></div>
        <div class="mikoto-slide slide-5"></div>
        <div id="mikoto-speech-container">
          <p id="mikoto-speech"></p>
        </div>
        <span id="mikoto-continue-indicator">▼</span>
      </div>
    </div>

    <script content-type="text/javascript" src="../lib/common.js"></script>
    <script content-type="text/javascript" src="solvers/idastar_solver.js"></script>
    <script content-type="text/javascript" src="solvers/astar_solver.js"></script>
    <script content-type="text/javascript" src="solvers/bfs_solver.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const advancedSettingsBtn = document.getElementById('advanced-settings-btn');
        const advancedSettingsPanel = document.getElementById('advanced-settings-panel');

        if (advancedSettingsBtn && advancedSettingsPanel) {
          advancedSettingsBtn.addEventListener('click', () => {
            advancedSettingsPanel.hidden = !advancedSettingsPanel.hidden;
          });
        }
      });
    </script>

    <script src="main.js"></script>
  </body>
</html>
