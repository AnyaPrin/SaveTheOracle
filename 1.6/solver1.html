<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save The Oracle Solver (Klotski Solver)</title>
    <style>
      :root {
          --bg-color: #1a1a1a;
          --surface-color: #2c2c2c;
          --button-color: #3c3c3c;
          --button-accent-color: #8e8c8e;
          --primary-text-color: #e0e0e0;
          --secondary-text-color: #a0a0a0;
          --primary-accent-color: #8c9eff;
          --secondary-accent-color: #5c6bc0;
          --success-color: #66bb6a;
          --error-color: #ef5350;
          --border-color: #424242;
      }

      html {
          height: 100%;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans",
		       "Noto Sans CJK JP", "Helvetica Neue", Arial, sans-serif;
          padding-left: 20px;
          margin-left: 20px;
          display: flex;
          min-width: 900px;
          min-height: 100vh;
          flex-direction: column;
          background-color: var(--bg-color);
          color: var(--primary-text-color);
          height: 100vh;
          overflow: hidden;
      }

      .top-panel {
          padding-top: 10px;
          overflow-y: auto;
          flex-shrink: 0;
          font-size: 14px;
      }

      .solution-panel {
          flex-grow: 1;
          overflow-y: auto;
          padding-bottom: 20px;
      }

      .container {
          position: relative;
	  z-index: 1;
	  background-size: cover;
	  background-repeat: no-repeat;
	  background-position: left;
	  justify-content: left;
	  max-width: 800px;
	  width:60%;
	  margin: 0 20px 0;
	  padding: 14px 25px 0; /* 上、左右、下 */
	  background-color: rgba(44, 44, 44, 0.85); /* 背景画像が見えるように半透明のオーバーレイに変更 */
	  border-radius: 18px;
	  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
	  text-align: left;
      }

      .container::before, .container::after {
	  content: '';
	  position: absolute;
	  top: 0; left: 0; right: 0; bottom: 0;
	  background-size: cover;
	  background-repeat: no-repeat;
	  background-position: left;
	  border-radius: 18px; /* Match container's border-radius */
	  z-index: -1;
	  }

	   .container::before {
	       background-image: url(bg_solver.jpg);
	   }

	   .container::after {
	       background-image: var(--after-bg-image, none);
	       opacity: 0;
	       transition: opacity 0.4s ease-in-out;
	   }

	   .container.bg-active::after {
	       opacity: 1;
	   }

	   .solution-panel .container {
	       padding-left: 0;
	       background: none;
	       background-color: none;
	       background-image: none;
	       border-radius: 8px;
	       box-shadow: none;
	       margin-top: 20px;
	   }

	   h1 {
	       color: var(--primary-text-color);
	       margin-bottom: 24px;
	   }

	   .info {
	       background-color: rgba(92, 107, 192, 0.15);
	       border-left: 5px solid var(--secondary-accent-color);
	       padding: 15px;
	       margin-bottom: 20px;
	       border-radius: 4px;
	       text-align: left;
	   }

	   .info p {
	       margin: 0;
	       line-height: 1.6;
	   }

	   .board {
	       white-space: pre;
	       font-family: monospace;
	       line-height: 1.1;
	       font-size: 1.5em;
	       margin-bottom: 20px;
	       text-align: left;
	       border: 2px solid var(--border-color);
	       display: inline-block;
	       padding: 4px;
	       border-radius: 4px;
	       background-color: var(--bg-color);
	   }

	   button {
	       background-color: var(--secondary-accent-color);
	       color: white;
	       padding: 12px 24px;
	       border: none;
	       border-radius: 5px;
	       font-size: 1em;
	       cursor: pointer;
	       transition: background-color 0.3s, transform 0.2s;
	       margin-bottom: 20px;
	       box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
	   }

	   button:hover {
	       background-color: var(--primary-accent-color);
	       transform: translateY(-2px);
	   }

	   button:disabled {
	       background-color: #424242;
	       color: #757575;
	       cursor: not-allowed;
	       box-shadow: none;
	       transform: none;
	   }
	   .icon-btn img {
	       width: 58px;
	       height: 58px;
	   }
	   /* Icon-based UI styles */
	   .action-buttons, .icon-group {
	       display: flex;
	       justify-content: flex-start;
	       gap: 0;
	       align-items: center;
	   }
	   .action-buttons {
	       margin-bottom: 10px; /* ボタン下のマージン */
	   }

	   .icon-btn {
	       /* Reset default button styles */
	       -webkit-appearance: none;
	       -moz-appearance: none;
	       appearance: none;
	       background: none;
	       padding: 0;
	       font-family: inherit;
	       color: inherit;

	       /* Icon styles */
	       width: 56px;
	       height: 56px;
	       background-color: #3a3a3a;
	       border: 2px solid #5a5a5a;
	       border-radius: 6px;
	       display: inline-flex; /* Use flex to center content */
	       align-items: center;
	       justify-content: center;

	       font-size: 2em;
	       cursor: pointer;
	       transition: all 0.2s ease;
	       user-select: none;
	       margin: 0;
	   }

	   #start-buttons-group {
	       display: flex;
	       align-items: center;
	       gap: 0;
	   }

	   .action-buttons.searching .icon-btn-label:not(.active-search) {
	       opacity: 0.4;
	       pointer-events: none;
	   }

	   .icon-btn:hover:not(:disabled) {
	       background-color: #4a4a4a;
	       border-color: var(--primary-accent-color);
	       transform: translateY(-2px);
	       box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
	   }

	   .icon-btn:disabled {
	       background-color: #2a2a2a;
	       border-color: #424242;
	       color: #666;
	       cursor: not-allowed;
	       transform: none;
	       box-shadow: none;
	   }

	   /* Hide the actual radio/checkbox input */
	   .icon-group input {
	       position: absolute;
	       opacity: 0;
	       width: 0;
	       height: 0;
	   }

	   #status {
	       font-size: 1em;
	       font-weight: bold;
	       color: var(--primary-accent-color);
	   }

	   #search-summary {
	       background-color: rgba(44, 44, 44, 0.5); /* 半透明の背景 */
	       backdrop-filter: blur(4px); /* すりガラス効果 */
	       -webkit-backdrop-filter: blur(4px); /* Safari用 */
	       border-radius: 8px;
	       padding: 15px 25px;
	       margin-bottom: 20px;
	       box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
	       border: 1px solid rgba(255, 255, 255, 0.1); /* 境界線を少し見せる */
	   }

	   #progress-details {
	       font-size: 0.7em;
	       color: var(--secondary-text-color);
	       margin-top: 0;
	   }

	   #save-status {
	       font-size: 0.9em;
	       color: var(--error-color);
	       margin-top: 10px;
	       min-height: 20px;
	   }
	   #save-status[style*="color: rgb(76, 175, 80)"] { /* For success message */
	       color: var(--success-color) !important;
	   }

	   #solution-path {
	       margin-top: 0;
	       text-align: left;
	       display: grid;
	       grid-template-columns: repeat(15, 1fr);
	       gap: 2px;
	   }

	   .step {
	       display: flex;
	       flex-direction: column;
	       align-items: center;
	       gap: 4px;
	   }

	   .step-number {
	       font-size: 0.8em;
	       font-weight: bold;
	       color: var(--secondary-text-color)
	   }


	   .step-board {
	       border: 1px solid var(--border-color);
	       padding: 5px;
	       border-radius: 4px;
	       background-color: var(--bg-color);
	       white-space: pre;
	       font-family: monospace;
	       line-height: 1.1;
	       font-size: 1em;
	       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
	   }

	   /* Style for when the hidden input is disabled */
	   .icon-group input:disabled + .icon-label {
	       background-color: #2a2a2a;
	       border-color: #424242;
	       color: #666;
	       cursor: not-allowed;
	       box-shadow: none;
	   }

	   .step-board.clickable-board {
	       cursor: pointer;
	       transition: border-color 0.2s ease;
	   }
	   .step-board.clickable-board:hover {
	       border-color: var(--primary-accent-color);
	   }
	   .moved-piece {
	       color: var(--success-color);
	       font-weight: bold;
	   }




	   .board-input-container {
	       display: flex;
	       align-items: center;
	       gap: 10px;

	   }

	   #initial-state-input {
	       /* flex-grow: 1; */
	       font-family: monospace;
	       width: 22ch; /* 20文字とパディング分を考慮 */
	       font-size: 1em;
	       padding: 7px;
	       border: 1px solid var(--border-color);
	       border-radius: 8px;
	       background-color: var(--bg-color);
	       color: var(--primary-text-color);
	   }
	   #set-state-btn {
	       padding: 4px 35px ;
	       margin: 0;
	       border: 1px solid var(--border-color);
	       flex-shrink: 0;
	   }
	   #set-state-status {
	       min-height: 1.2em;
	       font-size: 0.9em;
	       text-align: left;
	       margin-top: 5px;
	   }
	   #set-state-status[style*="color: rgb(76, 175, 80)"] { /* For success message */
	       color: var(--success-color) !important;
	   }
	   .pruning-selection {
	       margin-bottom: 20px;
	       /* text-align: center; */
	   }
	   .pruning-selection label {
	       margin: 0 10px;
	       font-size: 1em;
	       cursor: pointer;
	   }
	   #pruning-status {
	       color: var(--secondary-text-color);
	       margin-left: 10px;
	       font-size: 0.9em;
	   }

	   .separated-icon-label {
	       margin-left: 20px; /* IDA*を他のアイコンから離す */
	   }

	   .icon-btn-label {
	       position: relative;
	       display: inline-block;
	   }


	   /* --- Tooltip Styles --- */
	   .tooltip-text {
	       visibility: hidden;
	       width: 280px; /* ツールチップの幅 */
	       background-color: rgba(44, 44, 44, 0.1); /* 半透明の背景 */
	       backdrop-filter: blur(4px); /* すりガラス効果 */
	       -webkit-backdrop-filter: blur(4px); /* Safari用 */
	       color: var(--primary-text-color);
	       text-align: left;
	       border-radius: 6px;
	       padding: 10px 15px;
	       position: fixed; /* JSでビューポート基準の位置を計算するため */
	       z-index: 1000;
	       opacity: 0;
	       transition: opacity 0.3s ease;
	       font-size: 0.9em;
	       line-height: 1.5;
	       box-shadow: 0 4px 12px rgba(0,0,0,0.5);
	       pointer-events: none; /* ツールチップ自体がマウスイベントを妨げないようにする */
	       --arrow-left: 50%; /* JSから矢印の位置を動的に設定するためのCSS変数 */
	   }
	   /* ツールチップの矢印 */
	   .tooltip-text::after {
	       content: "";
	       position: absolute;
	       left: var(--arrow-left);
	       transform: translateX(-50%);
	       border-width: 5px;
	       border-style: solid;
	   }

	   /* 上に表示する場合の矢印（下向き） */
	   .tooltip-text.arrow-down::after {
	       top: 100%;
	       border-color:rgba(44, 44, 44, 0.85) transparent transparent transparent;
	   }

	   /* 下に表示する場合の矢印（上向き） */
	   .tooltip-text.arrow-up::after {
	       bottom: 100%;
	       border-color: transparent transparent rgba(44, 44, 44, 0.85) transparent;
	   }

	   /* ホバー時にツールチップを表示 */
	   .tooltip-text.visible {
	       visibility: visible;
	       opacity: 1;
	   }
	   .tooltip-text strong {
	       color: var(--primary-accent-color);
	       font-weight: bold;
	   }


	   /* --- Mikoto Modal Styles --- */
	   #mikoto-modal {
	       position: fixed;
	       top: 0;
	       left: 0;
	       width: 100%;
	       height: 100%;
	       background-color: rgba(0, 0, 0, 0.75);
	       z-index: 2000;
	       display: none; /* JSで表示を制御 */
	       align-items: center;
	       justify-content: center;
	       opacity: 0;
	       transition: opacity 0.4s ease-in-out;
	   }
	   #mikoto-modal.is-active {
	       display: flex;
	       opacity: 1;
	   }
	   .mikoto-modal-content {
	       position: relative;
	       width: 90vw;
	       max-width: 1280px; /* 16:9の比率を保つための最大幅 */
	       aspect-ratio: 16 / 9;
	       background-color: #000;
	       border-radius: 12px;
	       box-shadow: 0 8px 32px rgba(0,0,0,0.5);
	       overflow: hidden;
	       cursor: pointer;
	   }
	   .mikoto-slide {
	       position: absolute;
	       top: 0; left: 0; width: 100%; height: 100%;
	       background-size: cover;
	       background-position: center;
	       opacity: 0;
	       visibility: hidden;
	       transition: opacity 0.5s ease-in-out;
	   }
	   .mikoto-slide.is-active {
	       opacity: 1;
	       visibility: visible;
	   }
	   /* 画像ファイルを配置してください */
	   .slide-1 { background-image: url('bg_mikoto_1.jpg'); }
	   .slide-2 { background-image: url('bg_mikoto_2.jpg'); }
	   .slide-3 { background-image: url('bg_mikoto_3.jpg'); }
	   .slide-4 { background-image: url('bg_mikoto_4.jpg'); }
	   .slide-5 { background-image: url('bg_mikoto_5.jpg'); }

	   #mikoto-speech-container {
	       position: absolute;
	       bottom: 0; left: 0; width: 100%; height: 28%;
	       padding: 20px 40px;
	       box-sizing: border-box;
	       text-shadow: 1px 1px 3px rgba(0,0,0,0.9);
	       white-space: pre-wrap;
	   }
	   #mikoto-continue-indicator {
	       position: absolute;
	       bottom: 15px;
	       right: 30px;
	       animation: blink 1.5s infinite;
	   }
	   #mikoto-speech {
	       color: black;
	       font-size: 0.78em;
	       line-height: 1.4;
	   }
	   @keyframes blink { 50% { opacity: 0.5; } }
	   #mikoto-modal-close {
	       all: unset; /* buttonのデフォルトスタイルをリセット */
	       position: absolute;
	       top: 10px;
	       right: 15px;
	       font-size: 2em;
	       cursor: pointer;
	       color: rgba(255,255,255,0.8);
	       transition: color 0.2s;
	       z-index: 10; /* テキストより手前に */
	   }
	   #mikoto-modal-close:hover {
	       color: white;
	   }

    </style>
  </head>
  <body>
    <div class="top-panel">
      <div class="container">
        <h1>SAVE THE ORACLE SOLVER</h1>
        <div class="board-input-container">
          <strong>初期盤面:</strong>
          <input type="text" id="initial-state-input" maxlength="20" minlength="20"
		 title="20文字の盤面状態 (A-Z, .)">
          <button id="set-state-btn">OK </button> <div id="set-state-status"></div>
        </div>
        <div class="pruning-selection" style="text-align: left">
          <label>
            <input type="checkbox" id="pruning-enabled" disabled> 最短解データによる枝刈りを有効にする
          </label><br>
          <label >
            <input type="checkbox" id="use-local-visited-enabled" disabled> 保存済み探索データを利用する
          </label><br>
          <span id="pruning-status"></span>

        </div>

        <div class="action-buttons">
          <label class="icon-btn-label">
            <button class="icon-btn start-algorithm-btn" value="bfs">
              <img src="../img/icon/bfs.png" alt="BFS">
            </button>
            <span class="tooltip-text">
              <strong>Brave Forwards Search (BFS)</strong><br>
              アルフィノがシャーレアン魔法大学在学中に開発したとされる最も基本的な探索アルゴリズム。スタートから近い順に全てのノードを網羅的に探索するため、必ず最短手数解を見つけます。
            </span>
          </label>
          <label class="icon-btn-label">
            <button class="icon-btn start-algorithm-btn" value="astar">
              <img src="../img/icon/astar.png" alt="A*">
            </button>
            <span class="tooltip-text">
              <strong>All-encompassed Super Tech Aragan Research (A*)</strong><br>
              ネロがアラグの超技術を利用して開発したらしい探索アルゴリズム。ゴールまでの推定コストを利用して探索を効率化、BFSと同様に最短手数解を保証しつつ、より高速に解を見つけることができます。
            </span>
          </label>
          <label class="icon-btn-label separated-icon-label">
            <button class="icon-btn start-algorithm-btn" value="idastar">
              <img src="../img/icon/idastar.png" alt="IDA*">
            </button>
            <span class="tooltip-text">
              <strong>Ironworks Designed Astar (IDA*)</strong><br>
              シドが開発したかもしれないA*探索の改良版。メモリ使用量を抑えられますが、このパズルのように同じ状態に何度も到達する問題では探索効率が著しく低下する場合があります。(試験的実装)
            </span>
          </label>

          <span style="border-left: 2px solid var(--border-color); height: 40px; margin: 0 15px;"></span>

          <label class="icon-btn-label">
            <button id="save-btn" class="icon-btn" disabled>
              <img src="../img/icon/save.png" alt="Save">
            </button>
            <span class="tooltip-text">
              <strong>探索結果を保存</strong><br>
              今回の探索で訪れた盤面（探索済みノード）をブラウザに保存します。次回以降の探索で再利用できます。
            </span>
          </label>
          <label class="icon-btn-label">
            <button id="check-data-btn" class="icon-btn">
              <img src="../img/icon/check.png" alt="Check">
            </button>
            <span class="tooltip-text">
              <strong>データ整合性チェック</strong><br>
              ブラウザに保存された探索済みデータに重複がないかチェックし、必要であればクリーンアップします。
            </span>
          </label>
        </div>
        <div id="save-status"></div>
      </div>
    </div>
    <div class="solution-panel">
      <div class="container">
        <div id="search-summary" hidden>
          <div id="status"></div>
          <div id="progress-details"></div>
        </div>
        <div id="solution-path"></div>
      </div>
    </div>

    <!-- Mikoto's Speech Modal -->
    <div id="mikoto-modal">
      <div class="mikoto-modal-content" title="クリックして進む">
        <button id="mikoto-modal-close" aria-label="閉じる">&times;</button>
        <div class="mikoto-slide slide-1 is-active"></div>
        <div class="mikoto-slide slide-2"></div>
        <div class="mikoto-slide slide-3"></div>
        <div class="mikoto-slide slide-4"></div>
        <div class="mikoto-slide slide-5"></div>
        <div id="mikoto-speech-container">
          <span id="mikoto-speech"></span>
        </div>
        <span id="mikoto-continue-indicator">▼</span>
      </div>
    </div>

    <script content-type="text/javascript" src="../lib/common.js"></script>
    <script content-type="text/javascript" src="solvers/idastar_solver.js"></script>
    <script content-type="text/javascript" src="solvers/astar_solver.js"></script>
    <script content-type="text/javascript" src="solvers/bfs_solver.js"></script>

    <script src="main.js"></script>
  </body>
</html>
